<!DOCTYPE html>
<html>

<head>
    <title>Exporter</title>
    <!-- <meta http-equiv="Content-Security-Policy"
        content="default-src *; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval' 'https://cdn.jsdelivr.net/npm/apexcharts'"> -->
    <link rel="stylesheet" href="/static/bootstrap.min.css">
    <!-- <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/luxon"></script>

</head>

<body class='bg-light container py-4'>
    <nav class="border-bottom navbar navbar-light bg-light justify-content-between">
        <span class="navbar-brand">Exporter</span>
    </nav>

    <!-- <div class='py-3 px-md-5'>
        <button type="button" class="btn btn-primary" onclick="getData()">Get data</button>
        <div id="chart"></div>
    </div> -->

    <div class='py-3 px-md-5' id='form'>
        <form onsubmit="return getData(event)">
            <div class="form-group">
                <label for="exampleInputEmail1">From</label>
                <input type="date" id="startDate" class="form-control" placeholder="From">
            </div>
            <div class="form-group mt-3">
                <label for="exampleInputPassword1">To</label>
                <input type="date" id="stopDate" class="form-control" placeholder="From">
            </div>
            <button type="submit" class="btn btn-primary mt-3">Submit</button>
        </form>
    </div>
    <div id="chart">
    </div>

    <footer class='pt-3 mt-4 border-top'>
        <p>Contact Sofus: <br />Telephone: +45 28 90 08 48 <br />Mail: sofus@addington.dk</p>
    </footer>

    <script>
        var DateTime = luxon.DateTime;
        let measurements = [];

        // Default stop date is today
        const defaultStartDate = DateTime.fromSeconds(1630454400)
        //defaultStartDate.setFullYear(defaultStartDate.getFullYear() - 1);
        // Default start date was last year
        // const defaultStopDate = DateTime.now();

        let startDate = document.getElementById('startDate')
        startDate.value = defaultStartDate.toISODate()
        let stopDate = document.getElementById('stopDate')
        stopDate.value = DateTime.now().toISODate()

        function getData(e) {
            e.preventDefault();

            const start = DateTime.fromISO(e.target.elements.startDate.value).toMillis()
            const stop = DateTime.fromISO(e.target.elements.stopDate.value).toMillis()
            const location = window.location.pathname.split('/')[2]
            const url = `/api/export/${location}/start/${start}/stop/${stop}/all`
            console.log(url)
            fetch(url)
                .then((response) => response.json())
                .then((data) => {

                    // measurements = formatMeasurements(data, start, stop)
                    let dataFormattet = []
                    for (let row of data) {
                        dataFormattet.push({
                            time: DateTime.fromMillis(row.time).toISO(),
                            door: row.door,
                            direction_in: row.direction_in,
                            direction_out: row.direction_out
                        })
                    }

                    // Download the data
                    const replacer = (key, value) => value === null ? '' : value // specify how you want to handle null values here
                    const header = Object.keys(dataFormattet[0])
                    const csv = [
                        header.join(','), // header row first
                        ...dataFormattet.map(row => header.map(fieldName => JSON.stringify(row[fieldName], replacer)).join(','))
                    ].join('\r\n')

                    var pom = document.createElement('a');
                    var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    var url = URL.createObjectURL(blob);
                    pom.href = url;
                    pom.setAttribute('download', 'data.csv');
                    pom.click();
                });
            return
        }


/*
        function formatMeasurements(input, start, stop) {
            var t0 = performance.now();
            // construct object
            let timeArray = {}
            const days = Math.round((stop - start) / (1000 * 60 * 60 * 24))
            for (let i = 0; i < days; i++) {
                timeArray[DateTime.fromMillis(start + i * (24 * 60 * 60 * 1000)).toISODate()] = {}
                for (let j = 0; j < 24; j++) {
                    timeArray[DateTime.fromMillis(start + i * (24 * 60 * 60 * 1000)).toISODate()][j] = 0
                }
            }

            // insert the data
            for (const measurement of input) {
                timeArray[DateTime.fromMillis(measurement.time).toISODate()][DateTime.fromMillis(measurement.time).toFormat('H')]++ || 1
            }

            // format to heatmeat

            let heatmapData = []
            for (const [day, count] of Object.entries(timeArray)) {
                let countArray = []
                for (const [time, counts] of Object.entries(count)) {
                    countArray.push({
                        x: time,
                        y: counts
                    })
                }

                heatmapData.push({
                    name: day,
                    data: countArray
                })
            }

            console.log(heatmapData)
            var options = {
                series: heatmapData,
                chart: {
                    height: 350,
                    type: 'heatmap',
                },
                dataLabels: {
                    enabled: false
                },
                colors: ["#008FFB"],
                title: {
                    text: 'HeatMap Chart (Single color)'
                },
            };

            var chart = new ApexCharts(document.querySelector("#chart"), options);
            chart.render();
            return input
        }
        */

    </script>
</body>

</html>