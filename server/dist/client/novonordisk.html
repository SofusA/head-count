<!DOCTYPE html>
<html>

<head>
  <title>Novonordisk Door Counter</title>
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/bootstrap.min.css">
  <link rel="stylesheet" href="/static/novonordisk.css">
</head>

<body>
  <div class='container-fluid bg-light' style='height:100vh'>
    <!-- Today row -->
    <div class='row' style='height:30vh'>
      <div class='col spaceline'> <h3 id='year'></h3></div>
      <div class='col-10 counter-content'>
        <div class='row py-3'>
          <div class='col'>
            <i data-feather="coffee"></i>
            <h2 id='firstVisitor'></h2>
            <h3>First visitor</h3>
          </div>
          <div class='col'>
            <i data-feather="crosshair"></i>
            <h2 id='currentVisitors'></h2>
            <h3>Currently inside</h3>
          </div>
          <div class='col'>
            <i data-feather="map-pin"></i>
            <h2 id='todayVisitors'></h2>
            <h3>Visitors</h3>
          </div>
        </div>
      </div>
      <div class='col sideline '> <h3 style='color:white'>Today</h3></div>
    </div>

    <!-- Week hours row -->
    <div class='row' style='height:40vh'>
      <div class='col sideline counter-border-top-solid'><h3 style='color:white'>Visiting Hours</h3></div>
      <div id='chart' class='col-11 counter-content counter-border-top'></div>
    </div>


    <!-- The past row -->
    <div class='row' style='height:30vh'>
      <div class='col spaceline counter-border-top-solid'></div>
      <div id='chart' class='col-10 counter-content counter-border-top'>
        <div class='row py-3'>
          <div class='col'>
            <i data-feather="feather"></i>
            <h2 id='nightOwls'></h2>
            <h3>Nightowls this year</h3>
          </div>
          <div class='col counter-border-right'>
            <i data-feather="sun"></i>
            <h2 id='yearVisitors'></h2>
            <h3>Visitors this year</h3>
          </div>
          <div class='col'>
            <i data-feather="moon"></i>
            <h2 id='monthVisitors'></h2>
            <h3>Visitors this month</h3>
          </div>
        </div>
      </div>
      <div class='col sideline counter-border-top-solid'><h3 style='color:white'>The past</h3></div>
    </div>
  </div>


  </div>
  <script>
    feather.replace()
  </script>

  <script src="/socket.io/socket.io.js"></script>
  <script src="/static/restart.js"></script>

  <script>
    var page = {
      year: document.getElementById('year'),
      firstVisitor: document.getElementById('firstVisitor'),
      currentVisitors: document.getElementById('currentVisitors'),
      todayMorning: document.getElementById('todayMorning'),
      todayAfternoon: document.getElementById('todayAfternoon'),
      todayNight: document.getElementById('todayNight'),
      todayVisitors: document.getElementById('todayVisitors'),
      weekVisitors: document.getElementById('weekVisitors'),
      monthVisitors: document.getElementById('monthVisitors'),
      yearVisitors: document.getElementById('yearVisitors'),
      nightOwls: document.getElementById('nightOwls'),
    }

    var socket = io(); // Initate Socket.io
    var DateTime = luxon.DateTime;

    socket.on("connect", function () {
      if (socket.emit('join', 'front/novonordisk')) {
        console.log('Subscribed to Novonordisk channel')
      } // Send join request to server
    });

    // When update message â†’ Update the table and store msg
    socket.on('update', function (msg) {
      console.log(msg)
      update(msg)

    })

    function update(msg) {
      msg['firstVisitor'] = firstVisitor(msg['firstVisitor']) // nice format the first visitor
      const d = new Date
      msg['year'] = d.getFullYear() + ' in numbers'
      for (const [key, value] of Object.entries(msg)) {
        if (page[key]) {
          page[key].innerHTML = value
        }
      }

    }

    const firstVisitor = (input) => {
      let output;

      if (input === 0) {
        output = "No early birds yet"
        return output
      }

      const date = new Date(input);

      const hours = "0" + date.getHours();
      const minutes = "0" + date.getMinutes();

      output = hours.substr(-2) + ":" + minutes.substr(-2);
      return output;
    }

    updateNightOwls()

    function updateNightOwls() {
      const stop = DateTime.now().toMillis()
      const start = DateTime.now().startOf('year').toMillis()
      const url = `api/export/novonordisk/start/${start}/stop/${stop}`
      fetch(url)
        .then((response) => response.json())
        .then((data) => {
          // console.log(data)
          let nightOwls = 0;
          for (const count of data) {
            const time = DateTime.fromMillis(count.time).toFormat('H');

            if (time < 6 || time > 20) {
              nightOwls++
            }
          }
          console.log('chainging')
          page['nightOwls'].innerHTML = nightOwls
        });
    }


    updateChart()
    setInterval(function () {
      updateChart()
    }, 60 * 1000);

    function updateChart() {
      const start = DateTime.now().startOf('day').plus({
        week: -1
      }).toMillis()
      const stop = DateTime.now().endOf('day').toMillis()
      const url = `api/export/novonordisk/start/${start}/stop/${stop}`
      fetch(url)
        .then((response) => response.json())
        .then((data) => {
          // console.log(data)
          chart.updateSeries(formatMeasurements(data, start, stop), false)
        });
    }

    function formatMeasurements(input, start, stop) {
      // construct object
      let timeArray = {}
      for (let i = 1; i < 8; i++) {
        timeArray[DateTime.fromMillis(start).plus({
          days: i
        }).toRelativeCalendar()] = {}
        for (let j = 0; j < 24; j++) {
          timeArray[DateTime.fromMillis(start).plus({
            days: i
          }).toRelativeCalendar()][j] = 0
        }
      }

      // insert the data
      for (const measurement of input) {
        const time = DateTime.fromMillis(measurement.time)
        if (timeArray[time.toRelativeCalendar()]) {
          timeArray[time.toRelativeCalendar()][time.toFormat('H')]++ || 1
        }
      }

      // format to heatmeat
      let heatmapData = []
      for (const [day, count] of Object.entries(timeArray)) {
        let countArray = []
        for (const [time, counts] of Object.entries(count)) {
          countArray.push({
            x: time,
            y: counts
          })
        }

        heatmapData.push({
          name: day,
          data: countArray
        })
      }

      return heatmapData
    }

    var options = {
      series: [],
      chart: {
        height: 350,
        type: 'heatmap',
        toolbar: {
          show: false
        }
      },
      animations: {
        enabled: false
      },
      dataLabels: {
        enabled: false
      },
      colors: ["#01387B"],
    };
    var chart = new ApexCharts(document.querySelector("#chart"), options);
    chart.render();
  </script>
</body>

</html>