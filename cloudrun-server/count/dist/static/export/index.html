<!DOCTYPE html>
<html>

<head>
  <title>Counter export</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.22.6/dist/umd/supabase.min.js"></script>

  <!-- Boostrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css"
    integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">

  <!-- Luxon -->
  <script src="https://cdn.jsdelivr.net/npm/luxon"></script>
</head>

<body class='bg-light container py-4'>
  <nav class="border-bottom navbar navbar-light bg-light justify-content-between">
    <span class="navbar-brand">Exporter</span>
  </nav>

  <div class='py-3 px-md-5' id='form'>
    <form onsubmit="return getData(event)">
      <div class="form-group">
        <label for="exampleInputEmail1">From</label>
        <input type="date" id="startDate" class="form-control" placeholder="From">
      </div>
      <div class="form-group mt-3">
        <label for="exampleInputPassword1">To</label>
        <input type="date" id="stopDate" class="form-control" placeholder="From">
      </div>
      <button type="submit" class="btn btn-primary mt-3">Submit</button>
    </form>
  </div>

  <footer class='pt-3 mt-4 border-top'>
    <p>Contact Sofus: <br />Telephone: +45 28 90 08 48 <br />Mail: sofus@addington.dk</p>
  </footer>

  <script>
    const supabaseUrl = 'https://flpcdxxaexyriudizhty.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlIjoiYW5vbiIsImlhdCI6MTYyNjQyNzkyOCwiZXhwIjoxOTQyMDAzOTI4fQ.XoT5qhcfNYapF_rDJxzokPX9eOGCB0hzBW5crHvcnoA'
    const db = supabase.createClient(supabaseUrl, supabaseKey)

    let DateTime = luxon.DateTime;

    const getData = (e) => {
      e.preventDefault();

      const start = DateTime.fromISO(e.target.elements.startDate.value).toMillis()
      const stop = DateTime.fromISO(e.target.elements.stopDate.value).toMillis()
      const location = window.location.search.substr(1)

      console.log({ start: start, stop: stop, location: location })

      collect(location, start, stop).then(data => {
        // measurements = formatMeasurements(data, start, stop)
        let dataFormattet = []
        for (let row of data) {
          dataFormattet.push({
            time: DateTime.fromMillis(row.time).toISO(),
            door: row.door,
            direction_in: row.direction_in,
            direction_out: row.direction_out
          })
        }

        // Download the data
        const replacer = (key, value) => value === null ? '' : value // specify how you want to handle null values here
        const header = Object.keys(dataFormattet[0])
        const csv = [
          header.join(','), // header row first
          ...dataFormattet.map(row => header.map(fieldName => JSON.stringify(row[fieldName], replacer)).join(','))
        ].join('\r\n')

        var pom = document.createElement('a');
        var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        var url = URL.createObjectURL(blob);
        pom.href = url;
        pom.setAttribute('download', 'data.csv');
        pom.click();
      })

    }

    const collect = async (location, start, stop) => {
      const { data, error } = await db
        .from('counter')
        .select('*')
        .eq('location', location)
        .gt('time', start)
        .lt('time', stop)

      if (error) { console.log(error) }
      return data
    }

  </script>
</body>

</html>